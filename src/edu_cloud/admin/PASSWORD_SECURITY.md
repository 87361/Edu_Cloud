# 密码安全说明

## 概述

本系统采用安全的密码存储方式，**所有密码都不会以明文形式存储**，管理员也无法查看用户的明文密码。

## 密码存储方式

### 1. 本地用户密码

**字段名**: `hashed_password`

**存储方式**: 
- 使用 **bcrypt** 算法进行单向哈希加密
- bcrypt 是一种安全的密码哈希算法，具有以下特点：
  - **单向加密**：无法从哈希值反推出原始密码
  - **加盐处理**：每次加密都会生成不同的哈希值（即使密码相同）
  - **计算成本可调**：可以调整计算复杂度以抵御暴力破解

**示例**:
```
原始密码: "admin123"
存储的哈希值: "$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyY5GyY5GyY5"
```

**安全性**:
- ✅ 即使数据库泄露，攻击者也无法直接获取用户密码
- ✅ 管理员无法查看明文密码
- ✅ 密码验证通过哈希比对完成，不需要存储明文

### 2. CAS用户密码

**字段名**: `cas_password_encrypted`

**存储方式**:
- 同样使用 **bcrypt** 算法进行单向哈希加密
- 与本地用户密码使用相同的加密方式

**为什么需要存储CAS密码？**
- CAS密码用于自动登录和抓取数据
- 系统需要验证CAS凭证的有效性
- 但即使存储了加密密码，也无法还原为明文

**安全性**:
- ✅ 使用与本地密码相同的安全加密方式
- ✅ 管理员无法查看明文密码
- ✅ 即使数据库泄露，也无法直接使用CAS密码

## 管理员权限限制

### 管理员可以查看的信息

✅ **可以查看**:
- 用户基本信息（用户名、邮箱、全名等）
- 用户角色（user/admin）
- 用户状态（是否激活）
- 创建时间
- CAS绑定状态（是否绑定、绑定时间）
- CAS用户名（学号）

❌ **无法查看**:
- 用户密码（包括哈希值）
- CAS密码（包括加密值）

### API安全措施

1. **用户列表API** (`/api/admin/users`):
   - 自动过滤密码字段
   - 只返回用户基本信息

2. **数据库表查看API** (`/api/admin/database/table/<table_name>`):
   - 自动过滤敏感字段（`hashed_password`, `cas_password_encrypted`）
   - 即使查询 `users` 表，也不会返回密码相关字段
   - 响应中会标注哪些字段被过滤

3. **数据库表结构API** (`/api/admin/database/tables`):
   - 会显示所有字段，但会标记敏感字段
   - 敏感字段在数据查看时会被自动过滤

## 密码验证流程

### 本地用户登录

```
1. 用户输入: username + password
2. 系统查询: 从数据库获取 hashed_password
3. 密码验证: bcrypt.verify(输入的密码, hashed_password)
4. 验证成功: 生成JWT token
```

### CAS用户登录

```
1. 用户输入: cas_username + cas_password
2. CAS验证: 调用BUPT_Auth验证CAS凭证
3. 验证成功: 
   - 加密并存储密码: cas_password_encrypted = bcrypt.hash(cas_password)
   - 生成JWT token
```

## 安全最佳实践

### 对用户

1. **使用强密码**:
   - 至少8个字符
   - 包含大小写字母、数字和特殊字符
   - 不要使用常见密码

2. **定期更换密码**:
   - 建议每3-6个月更换一次密码

3. **不要共享密码**:
   - 不要将密码告诉他人
   - 包括系统管理员

### 对管理员

1. **无法重置密码**:
   - 管理员无法查看或重置用户密码
   - 如需重置，需要通过"忘记密码"功能或联系用户

2. **审计日志**:
   - 建议记录管理员操作日志
   - 监控异常访问行为

3. **数据库安全**:
   - 定期备份数据库
   - 限制数据库访问权限
   - 使用加密连接

## 常见问题

### Q: 管理员能看到我的密码吗？

**A**: 不能。所有密码都使用bcrypt单向哈希加密，即使是管理员也无法查看明文密码。

### Q: 如果忘记密码怎么办？

**A**: 目前系统支持：
- 通过"忘记密码"功能重置（如果已实现）
- 联系系统管理员重置（管理员可以设置新密码，但无法查看旧密码）

### Q: CAS密码安全吗？

**A**: 是的。CAS密码使用与本地密码相同的bcrypt加密方式，即使数据库泄露也无法直接使用。

### Q: 为什么CAS密码需要存储？

**A**: CAS密码用于：
- 自动登录CAS系统
- 抓取课程和作业数据
- 验证CAS凭证有效性

但存储的是加密后的哈希值，无法还原为明文。

### Q: 密码哈希会被破解吗？

**A**: bcrypt算法非常安全：
- 计算成本高，暴力破解需要大量时间和资源
- 每次加密都使用不同的盐值，相同密码产生不同哈希
- 即使获得哈希值，也需要大量计算才能破解

但为了安全，建议：
- 使用强密码
- 定期更换密码
- 不要在多个系统使用相同密码

## 技术细节

### bcrypt参数

- **算法**: bcrypt
- **轮数**: 12（可调整，值越大越安全但计算越慢）
- **盐值**: 自动生成，每次加密都不同

### 密码验证示例代码

```python
from passlib.context import CryptContext

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# 加密密码
hashed = pwd_context.hash("user_password")
# 输出: "$2b$12$..."

# 验证密码
is_valid = pwd_context.verify("user_password", hashed)
# 输出: True 或 False
```

## 总结

- ✅ **所有密码都加密存储**，使用bcrypt单向哈希
- ✅ **管理员无法查看明文密码**
- ✅ **API自动过滤敏感字段**
- ✅ **符合安全最佳实践**

系统设计遵循"最小权限原则"和"数据最小化原则"，确保用户密码安全。

